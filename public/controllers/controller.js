(function(){
  var app = angular.module("MyApp",[]);

  MyController = app.controller("MyController", ['$scope', '$http', '$interval', function($scope, $http, $interval){

    // Initialize variables:
    $scope.timeRemaining = 3;
    $scope.currentRecord = {
      start:"", end:""
    };
    var sessionStarted = false;
    var countdown;
    var records = [];
        
    var getRecords = function() {
      $http.get('/typespeed').success(function(response) {
        console.log("getRecords Success function fired!");
        // Find the "response" object generated by server.js's routes
        // Remember to restart server!!!
        $scope.records = response;
      }); // End GET function
      console.log("getRecords function is running!");
    } // end getRecords

    getRecords();

    $scope.postRecord = function() {
      console.log("You are posting this info: " +$scope.currentRecord);

      $http.post('/typespeed', $scope.currentRecord).success(function(response) {
        console.log("postRecords Success function running!" +response);
        getRecords();
      }); // end POST function
    }; // end postRecords

    var stopCountDown = function() {
      $interval.cancel(countDown);
      $scope.currentRecord.end = (new Date()).getTime();
      $scope.postRecord();
    };

    var decreaseTime = function() {
      $scope.timeRemaining --;
      if ($scope.timeRemaining == 0) {
        stopCountDown();
        resetVariables();
      }
    };

    $scope.keyUp = function() {
      if (sessionStarted == false) {
        sessionStarted = true;
        // Start countdown
        countDown = $interval(decreaseTime,1000);
      }

      if ($scope.currentRecord.end == "") {
        // Reset timer
        $scope.timeRemaining = 3;
      }

      if ($scope.currentRecord.start == "") {
        // Record start time
        $scope.currentRecord.start = (new Date()).getTime();
        console.log("The start time is " +$scope.currentRecord.start);
      }
    } // keyUp

    // Calculations
    // ////////////

    $scope.toDateTime = function(unixTime) {
      return (new Date(unixTime)).toString('dddd, MMMM,yyyy');
    }

    $scope.wordCount = function(string) {
      if (typeof string != "undefined") {
        return string.split(" ").length;
      }
    }

    $scope.WPM = function(start,end) {
        wordCount = $scope.wordCount(string);
        minutes = (end - start) / 1000 / 60;
        return (wordCount / minutes);
    }

    $scope.mostFrequent = function(string) {
      wordsOriginal = string.split(" ").sort();
      wordsNew = wordsOriginal; // This will become words without ducpliates

      // Remove duplicates
      i = 0;
      while (i < wordsNew.length) {
        if (wordsNew[i] == wordsNew[i+1]) {
          wordsNew.splice((i+1),1);
        } else {
          i++;
        }
      }

      myObject = {};
    }
  
  }]); // End controller

})(); // Whole function closure